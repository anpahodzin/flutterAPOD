import 'dart:async';
import 'dart:convert';
import 'dart:developer';

import 'package:flutter_apod/config/env.dart';
import 'package:flutter_apod/model/post.dart';
import 'package:flutter_apod/utils/date.dart';
import 'package:http/http.dart' as http;

abstract class Network {
  final http.Client httpClient;

  Network({required this.httpClient});

  Future<List<Post>> loadPosts(DateTime startDate, DateTime endDate);
}

class ApiException implements Exception {
  final String message;
  final int code;

  ApiException(this.code, this.message);

  @override
  String toString() {
    return "ApiException:($code) $message";
  }
}

class RemoteNetwork extends Network {
  RemoteNetwork({required http.Client httpClient})
      : super(httpClient: httpClient);

  // todo
  static const String URL = Env.apodUrl;
  static const String API_KEY = Env.apodApiKey;

  Future<List<Post>> loadPosts(DateTime startDate, DateTime endDate) async {
    final start = startDate.formatDateApod();
    final end = endDate.formatDateApod();
    final url =
        Uri.parse("$URL?api_key=$API_KEY&start_date=$start&end_date=$end");
    final response = await httpClient.get(url);
    log("http => ${response.request?.url.toString()}"); // develop
    final output = "http <= ${response.statusCode} ${response.body}";
    log(output, sequenceNumber: output.length); // develop
    if (response.statusCode == 200) {
      final data = json.decode(response.body) as List;
      return data.reversed.map((rawPost) {
        return Post.fromJson(rawPost);
      }).toList();
    } else {
      throw ApiException(response.statusCode, 'error fetching posts');
    }
  }
}

class MockNetwork extends Network {
  MockNetwork({required super.httpClient});

  Future<List<Post>> loadPosts(DateTime startDate, DateTime endDate) async {
    const postRaw =
        """[{"copyright":"Bill Peters","date":"2020-07-17","explanation":"After local midnight on July 14 comet NEOWISE was still above the horizon for Goldenrod, Alberta, Canada, just north of Calgary, planet Earth. In this snapshot it makes for an awesome night with dancing displays of the northern lights. The long-tailed comet and auroral displays are beautiful apparitions in the north these days. Both show the influence of spaceweather and the wind from the Sun. Skygazers have widely welcomed the visitor from the Oort cloud, though C/2020 F3 (NEOWISE) is in an orbit that is now taking it out of the inner Solar System.  Comet NEOWISE Images: July 16 | July 15 | July 14 | July 13 | July 12 | July 11 | July 10 & earlier","hdurl":"https://apod.nasa.gov/apod/image/2007/DSC1028_PetersNEOWISEAuroralSpike.jpg","media_type":"image","service_version":"v1","title":"NEOWISE of the North","url":"https://apod.nasa.gov/apod/image/2007/DSC1028_PetersNEOWISEAuroralSpike_800.jpg"},{"copyright":"Tom Masterson","date":"2020-07-18","explanation":"If you can see the stars of the Big Dipper, you can find comet NEOWISE in your evening sky tonight. After sunset look for the naked-eye comet below the bowl of the famous celestial kitchen utensil of the north and above your northwestern horizon. 
        You're looking for a fuzzy 'star' with a tail, though probably not so long a tail as in this clear sky snapshot taken from Los Padres National Forest in California on the evening of July 16. Recent photographs of C/2020 F3 (NEOWISE) often show this comet's broad dust tail and fainter but separate ion tail extending farther than the eye can follow. Skygazers around the world have been delighted to find NEOWISE, surprise visitor from the outer Solar System.  Comet NEOWISE Images: July 17 | July 16 | July 15 | July 14 | July 13 | July 12 | July 11 | July 10 & earlier","hdurl":"https://apod.nasa.gov/apod/image/2007/NEOWISEBelowBigDipper-7-16-2020-TomMasterson.jpg","media_type":"image","service_version":"v1","title":"Finding NEOWISE","url":"https://apod.nasa.gov/apod/image/2007/NEOWISEBelowBigDipper-7-16-2020-TomMasterson1081.jpg"},{"date":"2020-07-19","explanation":"No one, presently, sees the Moon rotate like this. That's because the Earth's moon is tidally locked to the Earth, showing us only one side.  Given modern digital technology, however, combined with many detailed images returned by the Lunar Reconnaissance Orbiter (LRO), a high resolution virtual Moon rotation movie has been composed. The featured time-lapse video starts with the standard Earth view of the Moon. 
        Quickly, though, Mare Orientale, a large crater with a dark center that is difficult to see from the Earth, rotates into view just below the equator.  From an entire lunar month condensed into 24 seconds, the video clearly shows that the Earth side of the Moon contains an abundance of dark lunar maria, while the lunar far side is dominated by bright lunar highlands. Currently, over 19 new missions to the Moon are under active development from eight different countries, most of which have expected launch dates in the next three years.    Notable Images of Comet NEOWISE Submitted to APOD: July || 18  || 17  || 16  || 15  || 14  || 13  || 12  || 11  || 10 & earlier ||","media_type":"video","service_version":"v1","title":"Rotating Moon from LRO","url":"https://www.youtube.com/embed/sNUNB6CMnE8?rel=0"},{"copyright":"Jarek Oszywa","date":"2020-07-20","explanation":"Would you brave wild animals to photograph this sky? One astrophotographer did -- and we all get to reap the rewards.  First, thousands of stars were visible with many of the brightest impressively blue. Next, several red-glowing nebulae were discernible, including the California Nebula on the far right, and, above it, the Heart and Soul nebulae. 
        But the real reason to brave the local wildlife was Comet NEOWISE, visible on the left.  In the featured long-duration composite taken last week, Comet NEOWISE's blue-glowing ion tail points straight up, away from the rising Sun, while the Sun-reflecting dust tail trails off toward the right.  The picture combines three exposures taken consecutively over 10 minutes from the same location near Miedzyg\u00f3rze, Poland.  A moonlit dirt road shows the path ahead, while the \u015anieznik Mountains is visible on the horizon. Comet C/2020 F3 (NEOWISE) passes its closest to the Earth next week, after which the 5-km wide, evaporating, icy dirtball will fade as it glides back to the outer Solar System.   Notable Images of Comet NEOWISE Submitted to APOD: July || 19  || 18   || 17   || 16   || 15  || 14  || 13  || 12  || 11  || 10 & earlier ||","hdurl":"https://apod.nasa.gov/apod/image/2007/NeowiseNebs_Oszywa_3000.jpg","media_type":"image","service_version":"v1","title":"Comet NEOWISE and Nebulae","url":"https://apod.nasa.gov/apod/image/2007/NeowiseNebs_Oszywa_960.jpg"},{"date":"2020-07-21","explanation":"Can stars, like caterpillars, transform themselves into butterflies? No, but in the case of the Butterfly Nebula -- it sure looks like it.
         Though its wingspan covers over 3 light-years and its estimated surface temperature exceeds 200,000 degrees, C, the dying central star of NGC 6302, the featured planetary nebula, has become exceptionally hot, shining brightly in visible and ultraviolet light but hidden from direct view by a dense torus of dust. This sharp close-up was recorded by the Hubble Space Telescope and is reprocessed here to show off the remarkable details of the complex planetary nebula, highlighting in particular light emitted by iron, shown in red.  NGC 6302 lies about 4,000 light-years away in the arachnologically correct constellation of the Scorpion (Scorpius). Planetary nebulas evolve from outer atmospheres of stars like our Sun, but usually fade in about 20,000 years.   Great Debates in Astronomy: 2020: How will humanity first discover extraterrestrial life?","hdurl":"https://apod.nasa.gov/apod/image/2007/Butterfly_HubbleSchmidt_4767.jpg","media_type":"image","service_version":"v1","title":"Iron in the Butterfly Nebula","url":"https://apod.nasa.gov/apod/image/2007/Butterfly_HubbleSchmidt_1080.jpg"},{"copyright":"Zixuan LinBeijing Normal U.","date":"2020-07-22","explanation":"What is creating the structure in Comet NEOWISE's tails? Of the two tails evident, 
         the blue ion tail on the left points directly away from the Sun and is pushed out by the flowing and charged solar wind. Structure in the ion tail comes from different rates of expelled blue-glowing ions from the comet's nucleus, as well as the always complex and continually changing structure of our Sun's wind. Most unusual for Comet C/2020 F3 (NEOWISE), though, is the wavy structure of its dust tail. This dust tail is pushed out by sunlight, but curves as heavier dust particles are better able to resist this light pressure and continue along a solar orbit.  Comet NEOWISE's impressive dust-tail striations are not fully understood, as yet, but likely related to rotating streams of sun-reflecting grit liberated by ice melting on its 5-kilometer wide nucleus.  The featured 40-image conglomerate, digitally enhanced, was captured three days ago through the dark skies of the Gobi Desert in Inner Mongolia, China. Comet NEOWISE will make it closest pass to the Earth tomorrow as it moves out from the Sun. The comet, already fading but still visible to the unaided eye, should fade more rapidly as it recedes from the Earth.    Notable NEOWISE Images Submitted to APOD: July  21 || 20 || 19  || 18   || 17   || 16   || 15  || 14  || 13  || 12  || 11  || 10 & earlier ||",
         "hdurl":"https://apod.nasa.gov/apod/image/2007/Neowise_Lin_3884.jpg","media_type":"image","service_version":"v1","title":"The Structured Tails of Comet NEOWISE","url":"https://apod.nasa.gov/apod/image/2007/Neowise_Lin_960.jpg"},{"copyright":"Stephane Guisard","date":"2020-07-23","explanation":"Comet dust falls through a twilight sky in this dream-like scene, but it's not part of a fairytale movie. Still, Castle Neuschwanstein, nestled in the Bavarian Alps, did inspire Disneyland's Sleeping Beauty Castle. Captured on July 20, the bright streak above the castle towers is likely a Perseid meteor. Though it peaks near mid-August, the annual summer meteor shower is active now. The meteor trail over the fairytale castle can be traced back to the shower's radiant in the heroic constellation Perseus off the top right of the frame. Perseid meteors are produced by dust from periodic Comet Swift-Tuttle. With its own broad dust tail now sweeping through northern skies the celestial apparition above the distant horizon is planet Earth's current darling, Comet NEOWISE.  Comet NEOWISE Images:  July  22 || 21 || 20 || 19  || 18   || 17   || 16   || 15  || 14  || 13  || 12  || 11  || 10 & earlier ||","hdurl":"https://apod.nasa.gov/apod/image/2007/SGUNeuschwansteinNeowiseIMG2532-1920.jpg",
         "media_type":"image","service_version":"v1","title":"Fairytale NEOWISE","url":"https://apod.nasa.gov/apod/image/2007/SGUNeuschwansteinNeowiseIMG2532-1050.jpg"},{"copyright":"Urs Leutenegger","date":"2020-07-24","explanation":"The multi-mirror, 17 meter-diameter MAGIC telescopes reflect this starry night sky from the Roque de los Muchachos European Northern Observatory on the Canary Island of La Palma. MAGIC stands for Major Atmospheric Gamma Imaging Cherenkov and the telescopes can see the brief flashes of optical light produced in particle air showers as high-energy gamma rays impact the Earth's upper atmosphere. On July 20, two of the three telescopes in view were looking for gamma rays from the center of our Milky Way galaxy. In reflection they show the bright stars of Sagittarius and Scorpius near the galactic center to the southeast. Beyond the segmented-mirror arrays, above the northwest horizon and below the Big Dipper is Comet NEOWISE. NEOWISE stands for Near Earth Object Wide-field Infrared Survey Explorer. That's the Earth-orbiting satellite used to discover the comet designated C/2020 F3, but you knew that.  Comet NEOWISE Images:  July  23 || 22 || 21 || 20 || 19  || 18   || 17   || 16   || 15  || 14  || 13  || 12  || 11  || 10 & earlier","hdurl":"https://apod.nasa.gov/apod/image/2007/DSC7590-Leutenegger.jpg",
         "media_type":"image","service_version":"v1","title":"MAGIC NEOWISE","url":"https://apod.nasa.gov/apod/image/2007/DSC7590-Leutenegger1200c.jpg"},{"copyright":"Jeff Dai","date":"2020-07-25","explanation":"On July 23, this Long March 5 heavy-lift rocket rose into a blue morning sky from China's Hainan Island Wenchang Satellite Launch Center. The rocket carried an orbiter, lander, and rover to ask Heavenly Questions on the ambitious Tianwen-1 mission to Mars. In fact Tianwen-1 was the second of three missions scheduled for a July departure to the Red Planet. The United Arab Emirates launched its Amal (Hope) Mars probe on July 19.  NASA's launch of its Mars Perseverance Rover from Cape Canaveral Air Force Station, USA is scheduled for July 30. That is the last planned Mars launch for 2020 though. The minimum-energy launch window for an expedition to Mars is coming to a close in 2020 and will reopen in 2022.  Comet NEOWISE images from planet Earth: July 24, 23, 22","hdurl":"https://apod.nasa.gov/apod/image/2007/169A2911Dai.jpg","media_type":"image","service_version":"v1","title":"Tianwen-1 Mission to Mars","url":"https://apod.nasa.gov/apod/image/2007/169A2911Dai1024.jpg"},{"date":"2020-07-26","explanation":"What would it look like to fly through the distant universe? To find out, a team of astronomers estimated the relative 
         distances to over 5,000 galaxies in one of the most distant fields of galaxies ever imaged: the Hubble Ultra Deep Field (HUDF). Because it takes light a long time to cross the universe, most galaxies visible in the featured video are seen when the universe was only a fraction of its current age, were still forming, and have unusual shapes when compared to modern galaxies. No mature looking spiral galaxies such as our Milky Way or the Andromeda galaxy yet exist. Toward the end of the video the virtual observer flies past the farthest galaxies in the HUDF field, recorded to have a redshift past 8. This early class of low luminosity galaxies likely contained energetic stars emitting light that transformed much of the remaining normal matter in the universe from a cold gas to a hot ionized plasma.   Astrophysicists: Browse 2,200+ codes in the Astrophysics Source Code Library","media_type":"video","service_version":"v1","title":"A Flight through the Hubble Ultra Deep Field","url":"https://www.youtube.com/embed/PDMp8a-YNe0?rel=0"},{"copyright":"Kevin Palmer","date":"2020-07-27","explanation":"Normally, Steamboat Point looks cool -- but not this cool. Every day, the iconic peak of the Bighorn Mountains is an interesting sight, in particular from US Highway 14 in Wyoming. On some rare days, the rocky vertical ridges 
         look even more incredible when seen in front of a distant lightning storm. Earlier this month, though, something even more unusual happened -- the naked-eye Comet NEOWISE rose above it in the middle of the night. Just as a distant lightning storm was occurring in the background.  Recognizing a rare opportunity, a determined astrophotographer spent a sleepless night capturing  over 1400 images of this unusual triple conjunction.  The featured image is among the best of them, with the foreground lit by the Moon off to the right.  Comet C/2020 F3 (NEOWISE) is now headed back to the outer Solar System, destined to return only in about 6700 years.   Comet NEOWISE Images: July  26 || 25 || 24 || 23 || 22 || 21 || 20 || 19  || 18   || 17   || 16   || 15  || 14  || 13  || 12  || 11  || 10 & earlier ||","hdurl":"https://apod.nasa.gov/apod/image/2007/CometLightning_Palmer_1920.jpg","media_type":"image","service_version":"v1","title":"Comet and Lightning Beyond Bighorn Mountains","url":"https://apod.nasa.gov/apod/image/2007/CometLightning_Palmer_960.jpg"}]""";
    final data = json.decode(postRaw) as List;
    return data.reversed.map((rawPost) {
      return Post.fromJson(rawPost);
    }).toList();
  }
}
